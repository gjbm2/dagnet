version: "1.0.0"
connections:
  # Amplitude - Analytics & Funnel Data
  # Uses Amplitude Dashboard REST API (Funnels)
  # Docs: https://developers.amplitude.com/docs/dashboard-rest-api
  - name: amplitude-prod
    provider: amplitude
    kind: http
    description: "Production Amplitude analytics for conversion funnel data"
    enabled: true
    credsRef: amplitude
    defaults:
      base_url: "https://amplitude.com/api/2"
      # Region-specific base URL:
      # - US: https://amplitude.com/api/2
      # - EU: https://analytics.eu.amplitude.com/api/2
      base_url: "https://amplitude.com/api/2"
    connection_string_schema:
      type: object
      properties:
        segment:  # Optional segmentation/filter definition (passes through to 's')
          type: array
          items:
            type: object
          description: "Optional array of segment filter objects as expected by Amplitude API"
    adapter:
      # NOTE: This pre_request transformation is REQUIRED for Amplitude
      # because DagNet query from(B).to(C).visited(A) must be transformed to
      # a full funnel A>B>C, then extract only the B>C conversion
      pre_request:
        script: |
          // Build full funnel including visited events
          const events = [];
          if (dsl.visited_event_ids && dsl.visited_event_ids.length > 0) {
            events.push(...dsl.visited_event_ids.map(id => ({ event_type: id })));
          }
          events.push({ event_type: dsl.from_event_id });
          events.push({ event_type: dsl.to_event_id });
          
          // Convert window to Amplitude date format (YYYYMMDD)
          const formatDate = (iso) => iso.split('T')[0].replace(/-/g, '');
          dsl.start_date = formatDate(window.start);
          dsl.end_date = formatDate(window.end);
          dsl.funnel_events = events;
          dsl.target_step_index = events.length - 2;  // Index of from_event in results
          
          return dsl;
      request:
        url_template: "{{defaults.base_url}}/funnels"
        method: POST
        headers:
          # Dashboard REST API uses HTTP Basic auth: API Key (username) + Secret Key (password)
          # Provide base64(apiKey:secretKey) in credentials.basic_auth_b64
          Authorization: "Basic {{credentials.basic_auth_b64}}"
          Content-Type: "application/json"
        body_template: |
          {
            "e": {{dsl.funnel_events}},
            "start": "{{dsl.start_date}}",
            "end": "{{dsl.end_date}}",
            "m": "uniques",
            "i": 1{{#connection_string.segment}},
            "s": {{connection_string.segment}}{{/connection_string.segment}}
          }
      response:
        ok_when:
          status: [200]
        extract:
          jmes:
            # Funnel response returns aggregated steps with counts
            from_count: "data.steps[{{dsl.target_step_index}}].count"
            to_count: "data.steps[{{dsl.target_step_index + 1}}].count"
      transform:
        steps:
          - var: p_mean
            jsonata: "to_count / from_count"
          - var: n
            jsonata: "from_count"
          - var: k
            jsonata: "to_count"
      upsert:
        mappings:
          - from: p_mean
            to: "/edges/{{edgeId}}/p/mean"
          - from: n
            to: "/edges/{{edgeId}}/p/evidence/n"
          - from: k
            to: "/edges/{{edgeId}}/p/evidence/k"

  # Google Sheets - Parameter Data
  - name: sheets-readonly
    provider: google-sheets
    kind: http
    description: "Read-only access to Google Sheets for parameter data"
    enabled: true
    credsRef: google-sheets
    defaults:
      api_version: "v4"
    connection_string_schema:
      type: object
      required: [spreadsheet_id, range]
      properties:
        spreadsheet_id:
          type: string
          description: "Google Sheets spreadsheet ID"
        range:
          type: string
          description: "A1 notation range (e.g., 'Sheet1!A1:B10')"
    adapter:
      request:
        url_template: "https://sheets.googleapis.com/{{defaults.api_version}}/spreadsheets/{{connection_string.spreadsheet_id}}/values/{{connection_string.range}}"
        method: GET
        headers:
          Authorization: "Bearer {{credentials.access_token}}"
      response:
        ok_when:
          status: [200]
        extract:
          jmes:
            values: "values"
      transform:
        steps:
          - var: p_mean
            jsonata: "$number(values[0][1])"
          - var: n
            jsonata: "$number(values[1][1])"
          - var: k
            jsonata: "$number(values[2][1])"
      upsert:
        mappings:
          - from: p_mean
            to: "/edges/{{edgeId}}/p/mean"
          - from: n
            to: "/edges/{{edgeId}}/p/evidence/n"
          - from: k
            to: "/edges/{{edgeId}}/p/evidence/k"

  # Statsig - Feature Gate/Experiment Configuration
  - name: statsig-prod
    provider: statsig
    kind: http
    description: "Production Statsig for experiment variant allocations"
    enabled: true
    credsRef: statsig
    defaults:
      base_url: "https://statsigapi.net/console/v1"
      environment: production
    connection_string_schema:
      type: object
      properties:
        project_id:
          type: string
          description: "Statsig project ID (optional override)"
    adapter:
      request:
        url_template: "{{defaults.base_url}}/gates/{{case_id}}"
        method: GET
        headers:
          STATSIG-API-KEY: "{{credentials.console_api_key}}"
          Content-Type: "application/json"
      response:
        ok_when:
          status: [200]
        extract:
          jmes:
            gate_id: "data.id"
            gate_name: "data.name"
            enabled: "data.enabled"
            rules: "data.rules"
      transform:
        steps:
          - var: variants
            jsonata: |
              rules[type='experiment'].returnValue{
                'variant_id': $string(id),
                'name': name,
                'allocation': passPercentage / 100
              }
      upsert:
        mappings:
          - from: variants
            to: "/nodes/{{nodeId}}/case/variants"

  # PostgreSQL - Example for SQL-based data sources (disabled by default)
  - name: postgres-analytics
    provider: postgres
    kind: sql
    description: "PostgreSQL analytics database (example - configure credentials to enable)"
    enabled: false
    credsRef: postgres
    defaults:
      schema: public
    connection_string_schema:
      type: object
      properties:
        table:
          type: string
          description: "Table name for query"
    adapter:
      request:
        url_template: "{{credentials.host}}:{{credentials.port}}/{{credentials.database}}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_template: |
          {
            "query": "SELECT COUNT(*) as n, SUM(CASE WHEN converted = true THEN 1 ELSE 0 END) as k FROM {{defaults.schema}}.{{connection_string.table}} WHERE event_from = '{{dsl.from_event_id}}' AND event_to = '{{dsl.to_event_id}}' AND timestamp BETWEEN '{{window.start}}' AND '{{window.end}}'"
          }
      response:
        ok_when:
          status: [200]
        extract:
          jmes:
            n: "rows[0].n"
            k: "rows[0].k"
      transform:
        steps:
          - var: p_mean
            jsonata: "k / n"
      upsert:
        mappings:
          - from: p_mean
            to: "/edges/{{edgeId}}/p/mean"
          - from: n
            to: "/edges/{{edgeId}}/p/evidence/n"
          - from: k
            to: "/edges/{{edgeId}}/p/evidence/k"

