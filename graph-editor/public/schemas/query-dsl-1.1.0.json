{
  "$id": "https://raw.githubusercontent.com/gjbm2/dagnet/main/schema/query-dsl-1.1.0.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "DagNet Query DSL",
  "description": "Schema for query expression strings used in data retrieval and graph path discrimination",
  "$comment": "Query DSL allows compact specification of graph path constraints for parameter files. Format: from(node).to(node).visited(node).exclude(node).case(id:variant). Version 1.1.0 adds cohort() for latency-tracked edges.",
  
  "type": "object",
  "required": ["raw"],
  "additionalProperties": false,
  "properties": {
    "raw": {
      "type": "string",
      "description": "Raw query string in DSL format",
      "pattern": "^from\\([a-z0-9_-]+\\)\\.to\\([a-z0-9_-]+\\)(\\.(visited|visitedAny|exclude|case|context|contextAny|window|cohort|minus|plus)\\([^)]+\\))*$",
      "examples": [
        "from(homepage).to(checkout)",
        "from(homepage).to(checkout).exclude(back-button)",
        "from(product-view).to(checkout).visited(add-to-cart)",
        "from(start).to(end).exclude(detour-a,detour-b).visited(checkpoint)",
        "from(homepage).to(checkout).case(onboarding-test:treatment)",
        "from(a).to(c).minus(d)",
        "from(a).to(m).minus(b).minus(d).plus(b,d)",
        "from(a).to(b).cohort(-30d:)",
        "from(a).to(b).cohort(1-Nov-25:7-Nov-25)",
        "from(a).to(b).cohort(anchor-node,-14d:)"
      ]
    },
    "ast": {
      "$ref": "#/$defs/QueryAST",
      "description": "Parsed abstract syntax tree (optional, for pre-parsed queries)"
    }
  },
  
  "$defs": {
    "QueryAST": {
      "type": "object",
      "description": "Parsed representation of query DSL",
      "required": ["functions"],
      "additionalProperties": false,
      "properties": {
        "functions": {
          "type": "array",
          "description": "Ordered list of query functions",
          "minItems": 2,
          "items": { "$ref": "#/$defs/QueryFunction" }
        }
      }
    },
    
    "QueryFunction": {
      "type": "object",
      "description": "Single function in query expression",
      "required": ["name", "args"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "enum": ["from", "to", "visited", "visitedAny", "exclude", "context", "contextAny", "case", "window", "cohort", "minus", "plus"],
          "description": "Function name"
        },
        "args": {
          "type": "array",
          "description": "Function arguments (node IDs, date ranges, or key:value pairs)",
          "minItems": 1,
          "items": {
            "type": "string",
            "pattern": "^[a-z0-9-]+(:[a-z0-9A-Z-]+)?$"
          }
        }
      }
    },
    
    "QueryFunctionName": {
      "type": "string",
      "enum": ["from", "to", "visited", "visitedAny", "exclude", "context", "contextAny", "window", "cohort", "case", "minus", "plus"],
      "description": "Valid query function names",
      "$comment": "Semantics: from(A)=start at node A, to(B)=end at node B, visited(X)=must visit X, visitedAny(X,Y)=visit at least one, exclude(Y)=must NOT visit Y, case(id:variant)=filter by experiment, context(key:val)=context constraint, contextAny(key:v1,v2)=OR over values for key, window(start:end)=time window for data (X-anchored), cohort(start:end)=cohort entry window (A-anchored for latency edges), cohort(anchor,start:end)=cohort with explicit anchor node, minus(node-list)=subtract paths visiting these nodes (inherits base from/to, coefficient -1), plus(node-list)=add back paths visiting these nodes (coefficient +1, for inclusion-exclusion)"
    }
  },
  
  "examples": [
    {
      "raw": "from(homepage).to(checkout)",
      "ast": {
        "functions": [
          { "name": "from", "args": ["homepage"] },
          { "name": "to", "args": ["checkout"] }
        ]
      }
    },
    {
      "raw": "from(product).to(checkout).visited(promo).exclude(abandoned-cart)",
      "ast": {
        "functions": [
          { "name": "from", "args": ["product"] },
          { "name": "to", "args": ["checkout"] },
          { "name": "visited", "args": ["promo"] },
          { "name": "exclude", "args": ["abandoned-cart"] }
        ]
      }
    },
    {
      "raw": "from(start).to(end).exclude(detour-a,detour-b)",
      "ast": {
        "functions": [
          { "name": "from", "args": ["start"] },
          { "name": "to", "args": ["end"] },
          { "name": "exclude", "args": ["detour-a", "detour-b"] }
        ]
      }
    },
    {
      "raw": "from(household-created).to(success).cohort(-90d:)",
      "ast": {
        "functions": [
          { "name": "from", "args": ["household-created"] },
          { "name": "to", "args": ["success"] },
          { "name": "cohort", "args": ["-90d:"] }
        ]
      }
    },
    {
      "raw": "from(switch-registered).to(success).cohort(delegated-household,1-Nov-25:30-Nov-25)",
      "ast": {
        "functions": [
          { "name": "from", "args": ["switch-registered"] },
          { "name": "to", "args": ["success"] },
          { "name": "cohort", "args": ["delegated-household", "1-Nov-25:30-Nov-25"] }
        ]
      }
    }
  ]
}

