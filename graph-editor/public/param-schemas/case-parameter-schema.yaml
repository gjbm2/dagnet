$schema: http://json-schema.org/draft-07/schema#
title: Case Parameter Schema
description: Schema for case/experiment parameters

type: object
required:
  - parameter_id
  - parameter_type
  - name
  - case
  - metadata

properties:
  parameter_id:
    type: string
    pattern: ^case-[a-z0-9-]+$
    description: Unique identifier for the case parameter
    
  parameter_type:
    type: string
    const: case
    description: Type of parameter (always 'case')
    
  name:
    type: string
    minLength: 1
    description: Human-readable name for the case
    
  description:
    type: string
    description: Optional description of the case
  
  description_overridden:
    type: boolean
    default: false
    description: If true, description was manually edited and should not be auto-updated
    
  case:
    type: object
    required:
      - id
      - status
      - variants
    properties:
      id:
        type: string
        description: Unique case identifier
        
      status:
        type: string
        enum: [active, paused, completed]
        description: Current status of the case
        
      connection:
        type: string
        description: |
          Connection name from connections.yaml (de facto foreign key).
          References a configured experiment platform connection.
          Example: "statsig-prod", "optimizely-prod", "launchdarkly-prod"
      
      connection_string:
            type: string
            description: |
          JSON blob of provider-specific settings (validated against connection_string_schema in connections.yaml).
          This is for case-specific overrides/specializations.
          Example for Statsig: {"project_id": "prod"}
          Example for Optimizely: {"environment": "production"}
          Secrets are NOT stored here - they're in credentials.yaml and referenced via credsRef in connections.yaml.
            
      variants:
        type: array
        minItems: 2
        description: Array of case variants
        items:
          type: object
          required:
            - name
            - weight
          properties:
            name:
              type: string
              description: Variant name
            weight:
              type: number
              minimum: 0
              maximum: 1
              description: Traffic allocation weight (0-1)
            weight_overridden:
              type: boolean
              default: false
              description: If true, weight was manually edited and should not be auto-updated from external source
            description:
              type: string
              description: Optional variant description
            statsig_variant_id:
              type: string
              description: Platform-specific variant ID
              
      schedules:
        type: array
        description: |
          Time-windowed variant configurations (historical record like parameter values).
          Most recent entry first. Each entry represents variant weights for a time period.
        items:
          type: object
          required: [window_from, variants]
          properties:
            window_from:
              type: string
              format: date-time
              description: Time window start (renamed from start_date for consistency)
            window_to:
              type: string
              format: date-time
              description: Time window end (optional, renamed from end_date for consistency)
            variants:
              type: object
              description: Variant name â†’ weight mapping for this time period
              additionalProperties:
                type: number
                minimum: 0
                maximum: 1
            retrieved_at:
              type: string
              format: date-time
              description: When this schedule data was retrieved (if from external source)
            edited_at:
              type: string
              format: date-time
              description: When this schedule was manually edited in the graph editor
            author:
              type: string
              description: User who manually edited this schedule (for manual edits)
            source:
              type: string
              enum: [statsig, optimizely, launchdarkly, manual]
              description: Where this schedule data came from
            note:
              type: string
              description: Optional note about this schedule
              
  history:
    type: array
    description: Historical snapshots of case parameters
    items:
      type: object
      properties:
        date:
          type: string
          format: date
          description: Snapshot date
        status:
          type: string
          enum: [active, paused, completed]
        variants:
          type: object
          description: Variant weights at this date
          additionalProperties:
            type: number
            
  applies_to:
    type: array
    description: Which graphs use this case parameter
    items:
      type: object
      properties:
        graph:
          type: string
          description: Graph name
        node_uuid:
          type: string
          description: Node UUID in the graph
          
  tags:
    type: array
    items:
      type: string
    description: Tags for categorization
    
  owner:
    type: string
    description: Owner of the case parameter
    
  contacts:
    type: array
    description: Contact information
    items:
      type: object
      properties:
        email:
          type: string
          format: email
        role:
          type: string
          enum: [owner, analyst, developer]
          
  metadata:
    type: object
    description: Metadata about this case definition
    required: [created_at, version]
    properties:
      created_at:
        type: string
        format: date-time
        description: ISO 8601 timestamp when case was created
      updated_at:
        type: string
        format: date-time
        description: ISO 8601 timestamp when case was last updated
      author:
        type: string
        minLength: 2
        maxLength: 64
        description: Author or team responsible for this case
      version:
        type: string
        pattern: ^\d+\.\d+\.\d+$
        description: Semantic version of this case definition
        examples: ["1.0.0", "1.2.3"]
      status:
        type: string
        enum: [active, deprecated, draft, archived]
        default: active
        description: Current status of this case definition
      tags:
        type: array
        items:
          type: string
        description: Tags for categorization (duplicates root-level tags for consistency)

examples:
  # Minimal example for new case creation (used as default template)
  - parameter_id: case-example
    parameter_type: case
    name: "Example Case"
    case:
      id: example
      status: active
      variants:
        - name: control
          weight: 0.5
        - name: treatment
          weight: 0.5
    metadata:
      created_at: "2025-01-01T00:00:00Z"
      updated_at: "2025-01-01T00:00:00Z"
      version: "1.0.0"

