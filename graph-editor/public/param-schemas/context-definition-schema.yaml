# Individual Context Definition Schema
# This schema defines the structure for a single context definition file
# in the Dagnet parameter registry system.

$schema: http://json-schema.org/draft-07/schema#
title: Context Definition
description: Contexts are categorical or ordinal dimensions used to slice and filter conversion data (e.g., marketing channel, device type, browser). They enable multi-dimensional analysis with MECE aggregation support.

type: object
required: [id, name, type, values, metadata]
additionalProperties: false

properties:
  id:
    type: string
    pattern: '^[a-zA-Z_][a-zA-Z0-9_-]*$'
    minLength: 2
    maxLength: 32
    description: "Context identifier (letters, numbers, underscores, hyphens)"
    examples: ["channel", "device", "utm_source", "geo_country"]
  
  name:
    type: string
    minLength: 3
    maxLength: 64
    description: "Human-readable context name"
    examples: ["Marketing Channel", "Device Type", "UTM Source"]
  
  description:
    type: string
    minLength: 10
    maxLength: 500
    description: "Detailed description of what this context represents"
  
  type:
    type: string
    enum: [categorical, ordinal, continuous]
    description: |
      Context type:
      - categorical: Discrete unordered values (e.g., channel, browser)
      - ordinal: Discrete ordered values (e.g., browser_version, time_of_day)
      - continuous: Numeric range (future: not yet implemented)
  
  otherPolicy:
    type: string
    enum: [null, computed, explicit, undefined]
    description: |
      Controls how the "other" catch-all bucket is handled:
      - null: No "other"; values are asserted MECE (complete)
      - computed: "other" = ALL - explicit values (computed dynamically)
      - explicit: "other" is a regular value with explicit mappings
      - undefined: No "other"; values NOT MECE (can't aggregate to total)
    default: undefined
  
  values:
    type: array
    minItems: 2
    items:
      type: object
      required: [id, label]
      additionalProperties: false
      properties:
        id:
          type: string
          pattern: '^[a-zA-Z0-9_-]+$'
          minLength: 1
          maxLength: 32
          description: "Value identifier (kebab-case or snake_case)"
          examples: ["google", "facebook", "mobile", "chrome-120"]
        
        label:
          type: string
          minLength: 1
          maxLength: 64
          description: "Human-readable label for UI display"
          examples: ["Google Ads", "Mobile", "Chrome 120+"]
        
        description:
          type: string
          maxLength: 200
          description: "Optional description of this value"
        
        order:
          type: integer
          minimum: 0
          description: "Order value for ordinal contexts (required if type is ordinal)"
        
        aliases:
          type: array
          items:
            type: string
            pattern: '^[a-zA-Z0-9_-]+$'
          uniqueItems: true
          description: "Alternative identifiers for this value"
        
        sources:
          type: object
          description: "Source-specific mappings for this value"
          additionalProperties:
            type: object
            properties:
              field:
                type: string
                description: "Source property/field name"
                examples: ["utm_source", "browser", "device_type"]
              
              filter:
                type: string
                description: "Explicit filter expression for this value"
                examples: ["utm_source == 'google'", "browser in ['Chrome', 'Chromium']"]
              
              pattern:
                type: string
                description: "Regex pattern for matching raw values (alternative to filter)"
                examples: ["^google", "^(facebook|fb|instagram|ig)_"]
              
              patternFlags:
                type: string
                description: "Regex flags (e.g., 'i' for case-insensitive)"
                examples: ["i", "im"]
    description: "Valid values for this context"
  
  metadata:
    type: object
    required: [created_at, version, status]
    properties:
      category:
        type: string
        enum: [marketing, technical, geographic, temporal, behavioral, business]
        description: "Category for grouping contexts in UI"
      
      data_source:
        type: string
        description: "Where this context data comes from"
        examples: ["utm_parameters", "user_agent", "geoip", "timestamp"]
      
      created_at:
        type: string
        format: date-time
        description: "ISO 8601 timestamp when context was created"
      
      updated_at:
        type: string
        format: date-time
        description: "ISO 8601 timestamp when context was last updated"
      
      version:
        type: string
        pattern: '^\d+\.\d+\.\d+$'
        description: "Semantic version of this context definition"
      
      status:
        type: string
        enum: [active, deprecated, draft]
        default: "active"
        description: "Current status of this context"
      
      author:
        type: string
        description: "Author or team responsible"
      
      deprecation_notice:
        type: string
        description: "Reason for deprecation (if status is deprecated)"
      
      replacement_context_id:
        type: string
        description: "ID of context that replaces this one (if deprecated)"
    additionalProperties: false

# Validation rules
allOf:
  # If type is ordinal, all values must have 'order' property
  - if:
      properties:
        type:
          const: ordinal
    then:
      properties:
        values:
          items:
            required: [order]

