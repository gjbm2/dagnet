# Event Definition Schema
# This schema defines the structure for individual event definitions
# in the Dagnet events registry system.

type: object
required: [id, name]
additionalProperties: false

properties:
  id:
    type: string
    pattern: '^[a-z0-9_]+$'
    minLength: 2
    maxLength: 128
    description: |
      Canonical event ID (used throughout app, likely matches production event names).
      Allows underscores for production event naming conventions (e.g., checkout_started).
    examples: ["checkout_started", "purchase_completed", "page_view", "add_to_cart"]
  
  name:
    type: string
    minLength: 3
    maxLength: 128
    description: "Human-readable event name"
    examples: ["Checkout Started", "Purchase Completed", "Page View", "Add to Cart"]
  
  description:
    type: string
    maxLength: 500
    description: "Detailed description of what this event represents"
    examples: 
      - "User initiates checkout process by clicking checkout button"
      - "User completes purchase and receives order confirmation"
  
  category:
    type: string
    enum: [user_action, system_event, milestone, conversion, page_view, error]
    description: "Event category for organization and filtering"
    examples: ["user_action", "conversion", "milestone"]
  
  tags:
    type: array
    items:
      type: string
      pattern: '^[a-z0-9-]+$'
    uniqueItems: true
    maxItems: 10
    description: "Tags for filtering, search, and categorization"
    examples: [["checkout", "conversion"], ["ecommerce", "payment"]]
  
  provider_event_names:
    type: object
    description: "Provider-specific event name mappings (flat key-value pairs)"
    additionalProperties:
      type: string
    examples:
      - amplitude: "ServiceLineManagement Confirmed"
        segment: "ServiceLineManagement Confirmed"
        mixpanel: "service_line_management_confirmed"
  
  connectors:
    type: object
    description: "Platform-specific mappings (only if platform uses different names)"
    additionalProperties: false
    properties:
      amplitude:
        type: object
        description: "Amplitude-specific configuration"
        additionalProperties: false
        properties:
          event_name:
            type: string
            description: "Override if Amplitude uses different event name than canonical id"
          event_type:
            type: string
            description: "Amplitude event type classification (if applicable)"
          properties:
            type: object
            description: "Expected event properties schema (for documentation)"
            additionalProperties: true
      
      google_analytics:
        type: object
        description: "Google Analytics configuration (future)"
        additionalProperties: true
      
      mixpanel:
        type: object
        description: "Mixpanel configuration (future)"
        additionalProperties: true
  
  properties:
    type: object
    description: "Expected event properties (for documentation and validation)"
    additionalProperties:
      type: object
      properties:
        type:
          type: string
          enum: [string, number, boolean, datetime, array, object]
          description: "Property data type"
        description:
          type: string
          description: "What this property represents"
        required:
          type: boolean
          default: false
          description: "Whether this property is required"
        examples:
          type: array
          items: {}
          description: "Example values for this property"
  
  metadata:
    type: object
    description: "Additional metadata about the event"
    properties:
      created_at:
        type: string
        format: date-time
        description: "When this event definition was created"
      
      updated_at:
        type: string
        format: date-time
        description: "When this event definition was last updated"
      
      author:
        type: string
        maxLength: 64
        description: "Author or team responsible for this event definition"
      
      version:
        type: string
        pattern: '^\\d+\\.\\d+\\.\\d+$'
        description: "Semantic version of this event definition"
      
      status:
        type: string
        enum: [active, deprecated, draft]
        default: "active"
        description: "Current status of the event"
      
      notes:
        type: string
        description: "Additional notes about this event"

# Example valid event definitions
examples:
  # Simple event matching Amplitude exactly
  - id: checkout_started
    name: "Checkout Started"
    description: "User initiates checkout process"
    category: "user_action"
    tags: ["checkout", "conversion", "ecommerce"]
    metadata:
      status: "active"
  
  # Event with platform override
  - id: purchase_completed
    name: "Purchase Completed"
    description: "User successfully completes a purchase transaction"
    category: "conversion"
    tags: ["purchase", "conversion", "revenue"]
    connectors:
      amplitude:
        event_name: "Purchase Complete"  # Amplitude uses slightly different name
        properties:
          transaction_id:
            type: string
            description: "Unique transaction identifier"
          revenue:
            type: number
            description: "Transaction revenue amount"
    properties:
      order_id:
        type: string
        description: "Order identifier"
        required: true
      total_amount:
        type: number
        description: "Total purchase amount in GBP"
        required: true
      currency:
        type: string
        description: "Currency code"
        examples: ["GBP", "USD", "EUR"]
      items:
        type: array
        description: "Array of purchased items"
    metadata:
      status: "active"
      version: "1.0.0"
  
  # Page view event
  - id: page_view
    name: "Page View"
    description: "User views a page on the website"
    category: "page_view"
    tags: ["navigation", "tracking"]
    properties:
      page_url:
        type: string
        description: "Full page URL"
        required: true
      page_title:
        type: string
        description: "Page title"
      referrer:
        type: string
        description: "Referring URL"
    metadata:
      status: "active"

