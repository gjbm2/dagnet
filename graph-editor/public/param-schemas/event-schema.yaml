# Event Definition Schema
# This schema defines the structure for individual event definitions
# in the Dagnet events registry system.

$schema: http://json-schema.org/draft-07/schema#
title: Event Definition
description: Events are used to define the events that can fire in the conversion graph. They are also used to store event name mappings and property filters for Amplitude queries.

type: object
required: [id, name]
additionalProperties: false

properties:
  id:
    type: string
    pattern: '^[a-zA-Z0-9_-]+$'
    minLength: 2
    maxLength: 128
    description: |
      Canonical event ID (letters, numbers, hyphens, underscores).
      Allows underscores for production event naming conventions.
    examples: ["checkout_started", "Purchase_Completed", "page_view", "Add_to_Cart"]
  
  name:
    type: string
    minLength: 3
    maxLength: 128
    description: "Human-readable event name"
    examples: ["Checkout Started", "Purchase Completed", "Page View", "Add to Cart"]
  
  description:
    type: string
    maxLength: 500
    description: "Detailed description of what this event represents"
    examples: 
      - "User initiates checkout process by clicking checkout button"
      - "User completes purchase and receives order confirmation"
  
  category:
    type: string
    enum: [user_action, system_event, milestone, conversion, page_view, error]
    description: "Event category for organization and filtering"
    examples: ["user_action", "conversion", "milestone"]
  
  tags:
    type: array
    items:
      type: string
      pattern: '^[a-zA-Z0-9_-]+$'
    uniqueItems: true
    maxItems: 10
    description: "Tags for filtering, search, and categorization"
    examples: [["checkout", "conversion"], ["ecommerce", "payment"]]
  
  provider_event_names:
    type: object
    description: "Provider-specific event name mappings (flat key-value pairs)"
    additionalProperties:
      type: string
    examples:
      - amplitude: "ServiceLineManagement Confirmed"
        segment: "ServiceLineManagement Confirmed"
        mixpanel: "service_line_management_confirmed"
  
  amplitude_filters:
    type: array
    description: "Property filters to apply when querying this event in Amplitude"
    items:
      type: object
      properties:
        property:
          type: string
          description: "Property name to filter on"
        operator:
          type: string
          enum: ["is", "is not", "is any of", "is not any of", "contains", "does not contain"]
          description: "Filter operator"
        values:
          type: array
          items:
            type: string
          description: "Values to filter by"
    examples:
      - - property: "value"
          operator: "is any of"
          values: ["DO_MOST_OF_IT_FOR_ME", "DO_ALL_OF_IT_FOR_ME"]
  
  metadata:
    type: object
    description: "Additional metadata about the event"
    properties:
      created_at:
        type: string
        format: date-time
        description: "When this event definition was created"
      
      updated_at:
        type: string
        format: date-time
        description: "When this event definition was last updated"
      
      status:
        type: string
        enum: [active, deprecated, draft]
        default: "active"
        description: "Current status of the event"
      
      notes:
        type: string
        description: "Additional notes about this event"

# Example valid event definitions
examples:
  # Default template for new event creation (first example is used by fileOperationsService)
  # Include all user-facing fields so the form editor renders them immediately.
  - id: example_event
    name: "Example Event"
    description: ""
    category: conversion
    tags: []
    provider_event_names:
      amplitude: ""
    amplitude_filters: []
  
  - id: household-delegated
    name: Delegation Completed
    description: Household has completed delegation step
    category: user_action
    tags: []
    provider_event_names:
      amplitude: Household DelegationStatusChanged
    amplitude_filters:
      - property: newDelegationStatus
        operator: is any of
        values:
          - 'ON'
    metadata:
      created_at: '2025-11-10T00:00:00.000Z'
      updated_at: '2025-11-19T23:59:11.112Z'
      status: active
      notes: |
        This event requires property-based filtering in Amplitude funnel queries
