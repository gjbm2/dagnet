# Parameter Definition Schema
# This schema defines the structure for individual parameter definitions
# in the Dagnet parameter registry system.

$schema: http://json-schema.org/draft-07/schema#
title: Parameter Definition
description: Parameters (probability and cost) are used to supply data and probabilities to the conversion graphs. They are also used to store conenction settings and act as 'data buckets'.

type: object
required: [id, name, type, values, metadata]
additionalProperties: false

properties:
  id:
    type: string
    pattern: '^[a-zA-Z0-9_-]+$'
    minLength: 1
    maxLength: 64
    description: "Unique parameter identifier (letters, numbers, hyphens, underscores)"
    examples: ["conversion-rate-baseline", "Email_Campaign_Cost", "checkout-duration"]
  
  name:
    type: string
    minLength: 3
    maxLength: 128
    description: "Human-readable parameter name"
    examples: ["Baseline Conversion Rate", "Email Campaign Cost", "Checkout Duration"]
  
  type:
    type: string
    enum: [probability, cost_gbp, cost_time]
    description: "Parameter type classification"
  
  query:
    type: string
    pattern: '^from\([a-zA-Z0-9_-]+\)\.to\([a-zA-Z0-9_-]+\)'
    description: "Query expression for data retrieval using DSL syntax"
    examples:
      - "from(checkout).to(purchase)"
      - "from(cart).to(checkout).exclude(abandoned)"
      - "from(landing).to(signup).visited(feature-view)"
      - "from(checkout).to(purchase).case(test-2025:treatment)"
  
  query_overridden:
    type: boolean
    default: false
    description: "If true, query was manually edited and should not be auto-regenerated"
  
  n_query:
    type: string
    pattern: '^from\([a-zA-Z0-9_-]+\)\.to\([a-zA-Z0-9_-]+\)'
    description: "Optional explicit query for n (denominator) when it differs from k query. Used when 'from' node shares an event with siblings and n can't be derived by stripping upstream conditions."
    examples:
      - "from(landing).to(feature-view)"
      - "from(checkout).to(cart-confirm)"
  
  n_query_overridden:
    type: boolean
    default: false
    description: "If true, n_query was manually edited and should not be auto-regenerated"
  
  connection:
    type: string
    description: "Connection name from connections.yaml"
  
  connection_string:
    type: string
    description: "JSON blob of provider-specific settings for parameter-specific overrides"
  
  values:
    type: array
    minItems: 1
    description: "Array of parameter values"
    items:
      type: object
      required: [mean]
      properties:
        mean:
          type: number
          description: "Mean/expected value"
          default: 1
        
        stdev:
          type: number
          minimum: 0
          description: "Standard deviation (optional)"
        
        n:
          type: integer
          minimum: 0
          description: "Sample size for statistical analysis"
        
        k:
          type: integer
          minimum: 0
          description: "Number of successes (for probability parameters)"
        
        # Daily breakdown (optional - if source supports daily data like Amplitude)
        n_daily:
          type: array
          items:
            type: integer
            minimum: 0
          description: "Daily sample sizes (optional)"
        
        k_daily:
          type: array
          items:
            type: integer
            minimum: 0
          description: "Daily successes (optional)"
        
        dates:
          type: array
          items:
            type: string
            format: date
          description: "Dates corresponding to n_daily/k_daily arrays"
        
        # Query signature (for consistency checking between successive values[] entries)
        query_signature:
          type: string
          description: "SHA-256 hash of query configuration for consistency checking"
        
        distribution:
          type: string
          enum: [normal, beta, gamma, lognormal, uniform]
          description: "Statistical distribution type (optional)"
        
        window_from:
          type: string
          format: date-time
          description: "Start of time window for this value"
        
        window_to:
          type: string
          format: date-time
          description: "End of time window for this value (optional)"
        
        context_id:
          type: string
          pattern: '^[a-zA-Z0-9_-]+$'
          description: "Optional context ID from contexts registry"
        
        data_source:
          type: object
          properties:
            type:
              type: string
              enum: [amplitude, sheets, api, file, manual, calculated, analytics, statsig, optimizely]
              description: "Source type for this specific value"
            url:
              type: string
              format: uri
              description: "URL or path to data source"
            retrieved_at:
              type: string
              format: date-time
              description: "Timestamp when data was retrieved from external source"
            edited_at:
              type: string
              format: date-time
              description: "Timestamp when data was manually edited"
            author:
              type: string
              description: "User who manually edited this value"
            query:
              type: object
              description: "Query configuration that produced this data"
              additionalProperties: true
            notes:
              type: string
              description: "Additional notes about data source"
            full_query:
              type: string
              description: "Complete DSL query string"
            debug_trace:
              type: string
              description: "Complete execution trace as JSON string for debugging"
          additionalProperties: false
      additionalProperties: false
  
  metadata:
    type: object
    required: [description, created_at, author, version]
    properties:
      description:
        type: string
        minLength: 10
        maxLength: 500
        description: "Description of the parameter"
      
      description_overridden:
        type: boolean
        default: false
        description: "If true, description was manually edited and should not be auto-updated"
      
      units:
        type: string
        maxLength: 32
        description: "Units of measurement"
        examples: ["probability", "USD", "seconds", "days", "percentage"]
      
      constraints:
        type: object
        properties:
          min:
            type: number
            description: "Minimum allowed value"
          max:
            type: number
            description: "Maximum allowed value"
          discrete:
            type: boolean
            default: false
            description: "Whether parameter takes discrete values only"
          step:
            type: number
            minimum: 0
            description: "Step size for discrete parameters"
        additionalProperties: false
      
      tags:
        type: array
        items:
          type: string
          pattern: '^[a-zA-Z0-9_-]+$'
        uniqueItems: true
        maxItems: 10
        description: "Tags for categorization and search"
        examples: [["conversion", "checkout", "baseline"], ["email", "marketing", "cost"]]
      
      created_at:
        type: string
        format: date-time
        description: "When parameter was created"
      
      updated_at:
        type: string
        format: date-time
        description: "When parameter was last updated"
      
      author:
        type: string
        minLength: 2
        maxLength: 64
        description: "Author or team responsible for this parameter"
      
      version:
        type: string
        pattern: '^\d+\.\d+\.\d+$'
        description: "Semantic version of this parameter definition"
        examples: ["1.0.0", "1.2.3", "2.0.0"]
      
      status:
        type: string
        enum: [active, deprecated, draft, archived]
        default: "active"
        description: "Current status of the parameter"
      
      aliases:
        type: array
        items:
          type: string
          pattern: '^[a-zA-Z0-9_-]+$'
        uniqueItems: true
        description: "Alternative identifiers for this parameter"
      
      references:
        type: array
        items:
          type: object
          properties:
            type:
              type: string
              enum: [paper, article, dataset, documentation]
            title:
              type: string
            url:
              type: string
              format: uri
            doi:
              type: string
          required: [type, title]
          additionalProperties: false
        description: "References to sources or documentation"
    additionalProperties: false

# Example valid parameter definitions
examples:
  # Minimal example for new parameter creation (used as default template)
  - id: example-param
    name: "Example Parameter"
    type: probability
    values:
      - mean: 0.5
    metadata:
      description: ""
      created_at: "2025-01-01T00:00:00Z"
      updated_at: "2025-01-01T00:00:00Z"
      author: "user"
      version: "1.0.0"
  
  # Simple probability parameter with single value
  - id: conversion-rate-baseline
    name: "Baseline Conversion Rate"
    type: probability
    query: "from(checkout).to(purchase)"
    query_overridden: false
    values:
      - mean: 0.15
        stdev: 0.03
        n: 1500
        k: 225
        distribution: "beta"
        window_from: "2025-01-01T00:00:00Z"
        window_to: "2025-03-31T23:59:59Z"
        data_source:
          type: "amplitude"
          retrieved_at: "2025-04-01T08:00:00Z"
          full_query: "from(checkout).to(purchase).window(2025-01-01:2025-03-31).context(device:mobile)"
          debug_trace: '{"query":"from(checkout).to(purchase)","connection":"amplitude-prod","connection_string":{"segment_filter":"exclude_test_users"},"window":{"from":"2025-01-01","to":"2025-03-31"},"context":{"device":"mobile"},"request":{"url":"https://amplitude.com/api/2/funnels","method":"POST","body":{...}},"response":{"status":200,"body":{...}}}'
    connection: "amplitude-prod"
    connection_string: '{"segment_filter": "exclude_test_users"}'
    metadata:
      description: "Baseline conversion rate for e-commerce checkout processes"
      description_overridden: false
      tags: ["conversion", "checkout", "baseline"]
      created_at: "2025-01-15T10:00:00Z"
      updated_at: "2025-04-01T08:00:00Z"
      author: "data-team"
      version: "1.1.0"
      status: "active"
  
  # Time-windowed parameter showing value evolution
  - id: email-open-rate
    name: "Email Campaign Open Rate"
    type: probability
    query: "from(email-sent).to(email-opened)"
    values:
      - mean: 0.22
        stdev: 0.04
        n: 5000
        k: 1100
        window_from: "2024-01-01T00:00:00Z"
        window_to: "2024-05-31T23:59:59Z"
        data_source:
          type: "sheets"
          url: "https://docs.google.com/spreadsheets/d/..."
          retrieved_at: "2024-06-01T09:00:00Z"
      - mean: 0.28
        stdev: 0.03
        n: 4800
        k: 1344
        window_from: "2024-06-01T00:00:00Z"
        window_to: "2024-09-30T23:59:59Z"
        data_source:
          type: "sheets"
          url: "https://docs.google.com/spreadsheets/d/..."
          retrieved_at: "2024-10-01T09:00:00Z"
          notes: "After email redesign"
      - mean: 0.32
        stdev: 0.02
        n: 5200
        k: 1664
        window_from: "2024-10-01T00:00:00Z"
        data_source:
          type: "analytics"
          retrieved_at: "2024-10-15T14:30:00Z"
          notes: "A/B test winner rolled out"
    connection: "sheets-readonly"
    connection_string: '{"range": "EmailMetrics!A2:E2"}'
    metadata:
      description: "Email open rate showing improvement over time"
      tags: ["email", "marketing", "engagement"]
      created_at: "2024-01-15T10:00:00Z"
      updated_at: "2024-10-15T14:30:00Z"
      author: "marketing-team"
      version: "1.3.0"
      status: "active"
  
  # Context-dependent parameter
  - id: checkout-conversion-by-device
    name: "Checkout Conversion Rate by Device Type"
    type: probability
    values:
      - mean: 0.18
        stdev: 0.03
        context_id: "device-desktop"
      - mean: 0.12
        stdev: 0.04
        context_id: "device-mobile"
      - mean: 0.15
        stdev: 0.03
        context_id: "device-tablet"
    metadata:
      description: "Checkout conversion varies significantly by device type"
      tags: ["conversion", "checkout", "device", "context-dependent"]
      created_at: "2025-01-10T10:00:00Z"
      author: "analytics-team"
      version: "1.0.0"
      status: "active"
