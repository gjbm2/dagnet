# Parameter Definition Schema
# This schema defines the structure for individual parameter definitions
# in the Dagnet parameter registry system.

type: object
required: [id, name, type, values, metadata]
additionalProperties: false

properties:
  id:
    type: string
    pattern: '^[a-z0-9-]+$'
    minLength: 3
    maxLength: 64
    description: "Unique parameter identifier (slug) - lowercase, alphanumeric, hyphens only"
    examples: ["conversion-rate-baseline", "email-campaign-cost", "checkout-duration"]
  
  name:
    type: string
    minLength: 3
    maxLength: 128
    description: "Human-readable parameter name"
    examples: ["Baseline Conversion Rate", "Email Campaign Cost", "Checkout Duration"]
  
  type:
    type: string
    enum: [probability, cost_gbp, cost_time]
    description: |
      Parameter type classification:
      - probability: 0-1 value representing likelihood
      - cost_gbp: monetary cost in GBP
      - cost_time: time cost in days (or fractions thereof)
  
  values:
    type: array
    minItems: 1
    description: "Array of parameter values, optionally windowed by time and/or context"
    items:
      type: object
      required: [mean]
      properties:
        mean:
          type: number
          description: "Mean/expected value (default = 1 if not specified)"
          default: 1
        
        stdev:
          type: number
          minimum: 0
          description: "Standard deviation (optional)"
        
        distribution:
          type: string
          enum: [normal, beta, gamma, lognormal, uniform]
          description: "Statistical distribution type (optional)"
        
        window_from:
          type: string
          format: date-time
          description: |
            Start of time window for this value (ISO 8601 timestamp).
            If omitted, value applies from beginning of time or previous window.
            Window extends to next window_from or present day.
        
        context_id:
          type: string
          pattern: '^[a-z0-9-]+$'
          description: |
            Optional context ID from contexts registry.
            Allows parameter values to vary by context (e.g., device type, user segment).
        
        data_source:
          type: object
          properties:
            type:
              type: string
              enum: [sheets, api, file, manual, calculated, analytics]
              description: "Source type for this specific value"
            url:
              type: string
              format: uri
              description: "URL or path to data source"
            notes:
              type: string
              description: "Additional notes about data source"
          additionalProperties: false
      additionalProperties: false
  
  metadata:
    type: object
    required: [description, created_at, author, version]
    properties:
      description:
        type: string
        minLength: 10
        maxLength: 500
        description: "Detailed description of the parameter"
      
      units:
        type: string
        maxLength: 32
        description: "Units of measurement"
        examples: ["probability", "USD", "seconds", "days", "percentage"]
      
      constraints:
        type: object
        properties:
          min:
            type: number
            description: "Minimum allowed value"
          max:
            type: number
            description: "Maximum allowed value"
          discrete:
            type: boolean
            default: false
            description: "Whether parameter takes discrete values only"
          step:
            type: number
            minimum: 0
            description: "Step size for discrete parameters"
        additionalProperties: false
      
      data_source:
        type: object
        properties:
          type:
            type: string
            enum: [sheets, api, file, manual, calculated, analytics]
            description: "Source type for parameter updates"
          url:
            type: string
            format: uri
            description: "URL or path to data source"
          refresh_frequency:
            type: string
            pattern: '^\\d+[smhd]$'
            description: "How often to refresh from source (e.g., '1h', '6h', '1d')"
          notes:
            type: string
            description: "Additional notes about the data source"
        additionalProperties: false
      
      analytics:
        type: object
        properties:
          bayesian_prior:
            type: object
            description: "Bayesian prior parameters"
            properties:
              alpha:
                type: number
                minimum: 0
                description: "Alpha parameter for beta distribution"
              beta:
                type: number
                minimum: 0
                description: "Beta parameter for beta distribution"
              mu:
                type: number
                description: "Mean for normal distribution"
              sigma:
                type: number
                minimum: 0
                description: "Standard deviation for normal distribution"
            additionalProperties: false
          
          mcmc_config:
            type: object
            description: "MCMC sampling configuration"
            properties:
              samples:
                type: integer
                minimum: 1000
                default: 10000
                description: "Number of MCMC samples"
              burn_in:
                type: integer
                minimum: 100
                default: 1000
                description: "Number of burn-in samples"
              chains:
                type: integer
                minimum: 1
                default: 4
                description: "Number of MCMC chains"
            additionalProperties: false
          
          update_frequency:
            type: string
            pattern: '^\\d+[smhd]$'
            description: "How often to update parameter via analytics"
          
          dependencies:
            type: array
            items:
              type: string
            description: "List of parameter IDs this parameter depends on"
        additionalProperties: false
      
      tags:
        type: array
        items:
          type: string
          pattern: '^[a-z0-9-]+$'
        uniqueItems: true
        maxItems: 10
        description: "Tags for categorization and search"
        examples: [["conversion", "checkout", "baseline"], ["email", "marketing", "cost"]]
      
      created_at:
        type: string
        format: date-time
        description: "ISO 8601 timestamp when parameter was created"
      
      updated_at:
        type: string
        format: date-time
        description: "ISO 8601 timestamp when parameter was last updated"
      
      author:
        type: string
        minLength: 2
        maxLength: 64
        description: "Author or team responsible for this parameter"
      
      version:
        type: string
        pattern: '^\\d+\\.\\d+\\.\\d+$'
        description: "Semantic version of this parameter definition"
        examples: ["1.0.0", "1.2.3", "2.0.0"]
      
      status:
        type: string
        enum: [active, deprecated, draft, archived]
        default: "active"
        description: "Current status of the parameter"
      
      aliases:
        type: array
        items:
          type: string
          pattern: '^[a-z0-9-]+$'
        uniqueItems: true
        description: "Alternative identifiers for this parameter"
      
      references:
        type: array
        items:
          type: object
          properties:
            type:
              type: string
              enum: [paper, article, dataset, documentation]
            title:
              type: string
            url:
              type: string
              format: uri
            doi:
              type: string
          required: [type, title]
          additionalProperties: false
        description: "References to sources or documentation"
    additionalProperties: false

# Example valid parameter definitions
examples:
  # Simple probability parameter with single value
  - id: conversion-rate-baseline
    name: "Baseline Conversion Rate"
    type: probability
    values:
      - mean: 0.15
        stdev: 0.03
        distribution: "beta"
    metadata:
      description: "Baseline conversion rate for e-commerce checkout processes"
      data_source:
        type: "analytics"
        notes: "Derived from 6 months of checkout data"
      tags: ["conversion", "checkout", "baseline"]
      created_at: "2025-01-15T10:00:00Z"
      updated_at: "2025-01-15T10:00:00Z"
      author: "data-team"
      version: "1.0.0"
      status: "active"
  
  # Time-windowed parameter showing value evolution
  - id: email-open-rate
    name: "Email Campaign Open Rate"
    type: probability
    values:
      - mean: 0.22
        stdev: 0.04
        window_from: "2024-01-01T00:00:00Z"
        data_source:
          type: "sheets"
          url: "https://docs.google.com/spreadsheets/d/..."
      - mean: 0.28
        stdev: 0.03
        window_from: "2024-06-01T00:00:00Z"
        data_source:
          type: "sheets"
          url: "https://docs.google.com/spreadsheets/d/..."
          notes: "After email redesign"
      - mean: 0.32
        stdev: 0.02
        window_from: "2024-10-01T00:00:00Z"
        data_source:
          type: "analytics"
          notes: "A/B test winner rolled out"
    metadata:
      description: "Email open rate showing improvement over time"
      tags: ["email", "marketing", "engagement"]
      created_at: "2024-01-15T10:00:00Z"
      updated_at: "2024-10-15T14:30:00Z"
      author: "marketing-team"
      version: "1.3.0"
      status: "active"
  
  # Context-dependent parameter
  - id: checkout-conversion-by-device
    name: "Checkout Conversion Rate by Device Type"
    type: probability
    values:
      - mean: 0.18
        stdev: 0.03
        context_id: "device-desktop"
      - mean: 0.12
        stdev: 0.04
        context_id: "device-mobile"
      - mean: 0.15
        stdev: 0.03
        context_id: "device-tablet"
    metadata:
      description: "Checkout conversion varies significantly by device type"
      tags: ["conversion", "checkout", "device", "context-dependent"]
      created_at: "2025-01-10T10:00:00Z"
      author: "analytics-team"
      version: "1.0.0"
      status: "active"
