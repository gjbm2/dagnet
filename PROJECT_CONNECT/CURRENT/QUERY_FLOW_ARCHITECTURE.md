# Query Flow Architecture

**Date:** 2025-11-07  
**Status:** ✅ IMPLEMENTED  
**Context:** Phase 1B - Query/Selector Component Design

---

## Executive Summary

**Query strings are GRAPH-AUTHORED and flow UNIDIRECTIONALLY to files.**

Queries do NOT sync from files back to graphs because they are context-dependent (tied to specific graph topology).

---

## The Architecture

### 1. Query Mastering Location

**Queries are mastered in the GRAPH, not in parameter files.**

```
GRAPH (master)           FILE (storage/retrieval)
  ↓                             ↓
edge.query  ────PUT───→   parameter.query
            ────CREATE──→
            
            ╳ NO GET ╳  (never flows back)
```

### 2. Query Generation

Queries are generated by:
- **MSMDC Algorithm**: Auto-derives minimal discriminating constraints from graph topology
- **Manual Editing**: User can override and manually refine queries
- **Override Flag**: `query_overridden: true` prevents MSMDC regeneration

### 3. Query Locations

**A. Edge-Level Query** (applies to all base parameters)
```typescript
edge: {
  query: "from(checkout).to(purchase)",  // ← For p, cost_gbp, cost_time
  query_overridden: boolean,
  
  p: { id: "param1", ... },
  cost_gbp: { id: "param2", ... },
  cost_time: { id: "param3", ... }
}
```

**B. Conditional-Level Query** (one per conditional)
```typescript
edge: {
  conditional_p: [
    {
      condition: "visited(promo)",  // ← Semantic: WHEN it applies
      query: "from(checkout).to(purchase).visited(promo)",  // ← Full: HOW to retrieve
      query_overridden: boolean,
      p: { id: "param-promo", ... }
    }
  ]
}
```

### 4. Condition vs Query

Two related but distinct concepts:

| Field | Purpose | Scope | Used By |
|-------|---------|-------|---------|
| **condition** | Runtime evaluation | Semantic constraint only | Graph evaluation engine |
| **query** | Data retrieval | Full topological path | External data services |

**Example:**
```typescript
conditional_p[0]: {
  condition: "visited(promo)",                              // WHEN: User visited promo
  query: "from(checkout).to(purchase).visited(promo)",     // HOW: Fetch this event sequence
  p: { ... }
}
```

- **condition**: Determines which conditional_p to use during graph traversal
- **query**: Tells Amplitude/Statsig exactly what data to fetch

### 5. Query Flow Operations

**CREATE (Graph → File):**
```typescript
// User creates new parameter file from edge
edge.query → parameter.query  ✅ Initial population
```

**UPDATE (Graph → File):**
```typescript
// User updates parameter metadata
edge.query → parameter.query  ✅ Keep in sync
```

**APPEND (Graph → File):**
```typescript
// User puts parameter values to file
edge.query → parameter.query  ✅ Update retrieval query
```

**GET (File → Graph):**
```typescript
// User gets parameter values from file
parameter.query ╳ edge.query  ❌ NO SYNC
```

### 6. Why Unidirectional?

**Problem with bidirectional sync:**

1. **Same graph scenario:** Circular - no new information
2. **Different graph scenario:** Query references nodes that don't exist in other graph
3. **MSMDC regeneration:** Stale query never updates if file keeps overwriting

**Solution:** Query is always derived from current graph topology, never retrieved from files.

---

## Implementation Details

### UpdateManager Mappings

**Graph → File (CREATE):**
```typescript
{ sourceField: 'query', targetField: 'query' }  // Line 696
```

**Graph → File (UPDATE):**
```typescript
{ sourceField: 'query', targetField: 'query' }  // Line 760
```

**File → Graph (UPDATE):**
```typescript
// REMOVED - no query mapping here
// Query is NOT synced from file to graph
```

### UI Components

**PropertiesPanel:**
- Edge-level QueryExpressionEditor below all three parameter sections
- Wired to `edge.query` and `edge.query_overridden`
- Shows "Data Retrieval Query (for all parameters)"
- Position: Bottom of Parameters card (less prominent - usually auto-generated)

**ParameterSection:**
- `showQueryEditor` prop controls visibility
- Set to `false` for base parameters (p, cost_gbp, cost_time)
- Query editor moved to BOTTOM (after distribution field)
- Label: "Data Retrieval Query"

**ConditionalProbabilityEditor (future):**
- Condition editor at TOP (semantic constraint)
- Query editor at BOTTOM (full retrieval query)
- Both use QueryExpressionEditor component

### Override Flag Semantics

`query_overridden` means:
- **TRUE:** User manually edited → MSMDC must NOT regenerate
- **FALSE:** Auto-generated → MSMDC can regenerate when topology changes

It does NOT mean "sync from file vs. don't sync" because we never sync from file.

---

## Future Features

### Query Suggestion Engine (Deferred)

Reverse direction: Survey parameter files to propose which params match an edge.

```typescript
// Future feature - not currently in scope
function suggestParametersForEdge(edge: Edge): Parameter[] {
  // 1. Scan available parameter files
  // 2. Match parameter.query against edge topology
  // 3. Propose parameters that fit this edge
  // 4. User reviews and connects
}
```

This is the ONLY scenario where `parameter.query` would be "read" by the graph editor - but it's still not a sync operation, it's a suggestion/search feature.

---

## Key Takeaways

1. ✅ **Query is graph-authored** (MSMDC or manual)
2. ✅ **Query flows graph → file only** (unidirectional)
3. ✅ **Query stored in file** for self-contained retrieval
4. ✅ **Query NOT retrieved** during GET operations
5. ✅ **Condition ≠ Query** (semantic vs topological)
6. ✅ **Edge query** applies to all base parameters
7. ✅ **Conditional query** one per conditional_p

---

**Last Updated:** 2025-11-07  
**Related Documents:**
- `DATA_MODEL_HIERARCHY.md` - Full data model specification
- `QUERY_EXPRESSION_SYSTEM.md` - Query DSL and MSMDC algorithm
- `OVERRIDE_PATTERN_DESIGN.md` - Override flag semantics

