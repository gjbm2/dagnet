# Connection Settings & Query Workflow Design

**Date:** 2025-11-05  
**Issue:** How do connection settings and MSMDC-generated queries interact during "Get from Source" operations?

**UPDATED:** Bidirectional override pattern - connection settings AND query both support graph ↔ file flexibility

---

## Core Insight: Asymmetric Mastery with Symmetric Override Pattern

**Two pieces of data, opposite primary locations:**

1. **Connection Settings** → Mastered in PARAM FILE, cached/overridden in GRAPH
   - Canonical: Stable config in param file (credentials, workspace, etc.)
   - Ad-hoc: Quick prototype by setting directly on graph edge
   - Override pattern: `edge.data_source.connection_overridden`

2. **Query** → Mastered in GRAPH, cached/overridden in PARAM FILE  
   - Canonical: MSMDC auto-generates on graph as structure changes
   - Cached: Param file stores last-used query for retrieval
   - Override pattern: `parameter.query_overridden`

**This enables:**
- ✅ Quick prototyping (graph-only, no param files)
- ✅ Canonical reusable params (file-based, shared across graphs)
- ✅ Mixed mode (some edges ad-hoc, some file-backed)

---

## The Problems

### Current Design State

**Per SCHEMA_FIELD_MAPPINGS.md:**

1. **Parameter File** stores `connection` settings:
```yaml
id: checkout-conversion
query: "from(checkout).to(purchase)"
query_overridden: false

connection:
  type: amplitude
  config:
    workspace: my-workspace
    api_secret_ref: amplitude-prod
    # ... other amplitude-specific config
```

2. **Graph Edge** has:
   - `edge.query` (auto-generated by MSMDC)
   - `edge.query_overridden` (false = auto-regenerate)
   - `edge.parameter_id` (link to param file)

3. **MSMDC Algorithm:**
   - Watches graph structure changes
   - Auto-updates `edge.query` (if not overridden)
   - Query changes when nodes are added/removed/reconnected

### The Sequence Problem

**Scenario:**
1. User edits graph (adds node, changes edge)
2. MSMDC auto-updates `edge.query` → `"from(checkout).to(purchase).exclude(mobile)"`
3. User clicks "Get from Source" on edge
4. **PROBLEM:** Parameter file still has old query: `"from(checkout).to(purchase)"`
5. External connector uses **old query** from param file to build API request
6. Retrieved data doesn't match current graph structure!

**Root Cause:** Graph knows the correct query, but connector reads from param file.

---

## Use Cases

### Use Case 1: Ad-Hoc Prototyping (Graph-Only, No Param Files)

**Scenario:**
1. User drags 2 nodes onto canvas (homepage, product-page)
2. User drags edge between them
3. **User clicks "Get from Source" immediately** (no param file created yet)
4. System needs to auto-generate connection settings on first use

**Requirements:**
- Edge must store `data_source` object directly
- On first "Get from Source", prompt user for minimal config (or use defaults)
- Auto-construct Amplitude query from MSMDC `edge.query`
- Store retrieved data in `edge.p.evidence` (no file)

**Data Flow:**
```
Graph Edge (standalone)
  ├─ query: "from(homepage).to(product-page)"  [MSMDC auto-gen]
  ├─ data_source:
  │    ├─ type: "amplitude"
  │    ├─ workspace: "default"  [auto or prompt]
  │    └─ connection_overridden: false
  └─ p:
       ├─ mean: 0.42  [retrieved]
       └─ evidence: {n: 1000, k: 420, retrieved_at: ...}
```

**This is already supported!** We called it "direct connection" mode.

---

### Use Case 2: Canonical Mode (File-Backed, Reusable)

**Scenario:**
1. User has established param file `checkout-conversion.yaml`
2. Multiple graphs use this parameter
3. Each graph has different structure → different MSMDC queries
4. Param file has stable connection settings

**Requirements:**
- Param file stores `connection` object (canonical source)
- Graph edge has `parameter_id` link
- Graph query auto-updates param file query on sync (if not overridden)
- Connection settings flow: file → graph (default behavior)

**Data Flow:**
```
Parameter File (canonical)
  ├─ id: checkout-conversion
  ├─ query: "from(checkout).to(purchase)"  [cached from last graph sync]
  ├─ query_overridden: false  [allows auto-update from graph]
  ├─ connection:  [canonical source]
  │    ├─ type: "amplitude"
  │    └─ config: {workspace: "prod", api_secret_ref: "amp-prod"}
  └─ values: [{mean: 0.3, n: 1000, ...}, ...]

Graph Edge (linked)
  ├─ parameter_id: "checkout-conversion"  [link to file]
  ├─ query: "from(checkout).to(purchase).exclude(mobile)"  [MSMDC current]
  ├─ query_overridden: false
  ├─ data_source: null  [uses file's connection]
  └─ p:
       ├─ mean: 0.3  [pulled from file]
       └─ parameter_id: "checkout-conversion"
```

---

### Use Case 3: Mixed Mode (Some Ad-Hoc, Some File-Backed)

**Scenario:**
1. User has 5 edges in graph
2. 3 edges linked to param files (canonical, reusable)
3. 2 edges are ad-hoc experiments (graph-only)
4. User wants to "Get from Source" on all of them

**Requirements:**
- System must detect which pathway to use per edge
- File-backed: Use file connection, update file query
- Ad-hoc: Use edge connection directly

**Detection Logic:**
```typescript
if (edge.p.parameter_id) {
  // File-backed mode
  const paramFile = await loadParameter(edge.p.parameter_id);
  
  // Check if edge overrides connection
  if (edge.data_source?.connection_overridden) {
    connection = edge.data_source;  // Use edge's override
  } else {
    connection = paramFile.connection;  // Use file's canonical
  }
  
  query = edge.query;  // Always from graph (MSMDC)
  
} else if (edge.data_source) {
  // Ad-hoc mode (no file)
  connection = edge.data_source;
  query = edge.query;
  
} else {
  // No connection configured
  throw new Error('No connection settings found');
}
```

---

## Recommended Solution: Bidirectional Override Pattern

### 1. Connection Settings Sync (File → Graph, with override)

**Default Behavior (file mastered):**
- Param file has `connection` object (canonical)
- Edge retrieves connection from file when needed
- Edge can cache connection locally for performance
- Edge can override connection with `connection_overridden` flag

**Sync Rules:**
```typescript
// When "Get from File" or "Get from Source (via file)"
if (!edge.data_source?.connection_overridden) {
  // Pull connection settings from param file
  edge.data_source = {
    ...paramFile.connection,
    connection_overridden: false  // Mark as synced, not overridden
  };
}

// User can override via "Connection Settings..." modal
// Sets edge.data_source.connection_overridden = true
// Future syncs will respect override and NOT pull from file
```

**Override Example:**
```typescript
// User opens "Connection Settings..." from lightning menu
// Edits workspace or credentials on the EDGE (not file)
edge.data_source = {
  type: 'amplitude',
  workspace: 'staging',  // Different from param file's 'prod'
  connection_overridden: true  // CRITICAL: Prevents auto-sync
};

// Next "Get from Source" uses edge.data_source, ignores param file connection
```

---

### 2. Query Sync (Graph → File, with override)

**Default Behavior (graph mastered):**
- Graph has `edge.query` (MSMDC auto-generated)
- Param file has `query` field (cached for retrieval)
- Param file has `query_overridden` flag
- If NOT overridden, graph query auto-updates param file during sync

**Sync Rules:**
```typescript
// When "Get from Source (via file)" or "Put to File"
if (!paramFile.query_overridden) {
  // Update param file query from graph
  paramFile.query = edge.query;
  // Mark param file dirty
  await fileRegistry.updateFile(`parameter-${edge.parameter_id}`, paramFile);
}

// User can override by manually editing param file query
// Sets paramFile.query_overridden = true
// Future syncs will respect override and NOT update from graph
```

**Why this matters:**
- MSMDC changes queries as graph structure evolves
- Param file needs current query to execute retrievals
- Auto-sync keeps param file query aligned with graph structure
- Override allows user to manually craft custom queries (edge case)

**The "Shared Param File" Problem:**
- If param file is used by multiple graphs...
- Each graph might generate different MSMDC queries
- Last graph to sync "wins" and updates param file query
- **Is this a problem?**
  - If graphs have same structure → same query (no conflict)
  - If graphs have different structure → queries differ (potential conflict)
  - **Solution:** If user wants different queries, use different param files
  - OR set `paramFile.query_overridden = true` to freeze it

---

### 3. UpdateManager Cascade Flow (MSMDC → Query → Param File)

**Trigger:** User edits graph (adds node, changes edge, etc.)

**Automatic Cascade:**
```typescript
// 1. MSMDC detects graph structure change
onGraphChange(node) {
  // 2. MSMDC regenerates queries for affected edges
  for (const edge of affectedEdges) {
    if (!edge.query_overridden) {
      edge.query = msmdc.generateQuery(edge, graph);
      
      // 3. Trigger UpdateManager cascade
      updateManager.onQueryChanged(edge);
    }
  }
}

// UpdateManager cascade logic
async onQueryChanged(edge: GraphEdge) {
  // Only cascade if edge is file-backed
  if (!edge.p?.parameter_id) return;
  
  const paramFile = await loadParameter(edge.p.parameter_id);
  
  // 4. Update param file query (if not overridden)
  if (!paramFile.query_overridden) {
    paramFile.query = edge.query;
    await fileRegistry.updateFile(`parameter-${edge.p.parameter_id}`, paramFile);
  }
  
  // 5. Sync connection settings back to edge (if not overridden)
  if (!edge.p.data_source?.connection_overridden && paramFile.connection) {
    edge.p.data_source = {
      source_type: paramFile.connection.source_type,
      connection_settings: paramFile.connection.connection_settings,
      connection_overridden: false
    };
  }
  
  this.emit('cascadeComplete', {
    edge: edge.uuid,
    paramFile: edge.p.parameter_id,
    queryUpdated: !paramFile.query_overridden,
    connectionSynced: !edge.p.data_source?.connection_overridden
  });
}
```

**Result:**
- Graph query change → Param file query updated (if not overridden)
- Param file connection → Edge connection refreshed (if not overridden)
- Bidirectional sync in single cascade operation
- Param file marked dirty for user review

---

### 4. Complete "Get from Source" Workflow

**Three pathways based on edge configuration:**

**Pathway A: File-Backed (Default, Canonical)**
```typescript
async function getFromSource_FileBacked(edge: GraphEdge) {
  const paramFile = await loadParameter(edge.p.parameter_id);
  
  // Connection: From param file (unless overridden on edge)
  const connection = edge.data_source?.connection_overridden 
    ? edge.data_source 
    : paramFile.connection;
  
  // Query: From graph (MSMDC-updated)
  const query = edge.query;
  
  // Update param file query (if not overridden)
  if (!paramFile.query_overridden) {
    paramFile.query = query;
  }
  
  // Execute retrieval
  const connector = await getConnector(connection.type);
  const data = await connector.retrieve({ query, ...connection.config });
  
  // Append to param file values[]
  paramFile.values.push({
    mean: data.mean,
    n: data.n,
    k: data.k,
    window_from: data.window_from,
    retrieved_at: new Date().toISOString(),
    data_source: { type: connection.type, retrieved_at: new Date().toISOString() }
  });
  
  // Mark param file + index dirty
  await fileRegistry.updateFile(`parameter-${edge.p.parameter_id}`, paramFile);
  
  // Update graph from file (standard flow)
  await updateManager.handleFileToGraph('UPDATE', 'parameter', paramFile, edge.uuid);
}
```

**Pathway B: Direct (Ad-Hoc, No File)**
```typescript
async function getFromSource_Direct(edge: GraphEdge) {
  // Connection: From edge (standalone)
  if (!edge.data_source) {
    // First use - prompt user or use defaults
    edge.data_source = await promptForConnectionSettings();
  }
  
  const connection = edge.data_source;
  const query = edge.query;
  
  // Execute retrieval
  const connector = await getConnector(connection.type);
  const data = await connector.retrieve({ query, ...connection.config });
  
  // Update graph directly (no file)
  edge.p.mean = data.mean;
  edge.p.evidence = {
    n: data.n,
    k: data.k,
    window_from: data.window_from,
    retrieved_at: new Date().toISOString(),
    source: connection.type
  };
  
  // No file changes, no dirty state
}
```

**Pathway C: Hybrid (File-Backed, Connection Overridden on Edge)**
```typescript
// Same as Pathway A, but uses edge.data_source instead of paramFile.connection
// Useful when user wants to test against different Amplitude workspace
// but still wants to append data to param file for history
```

**Pros:**
- Graph query is always authoritative
- No sync issues
- Parameter file gets updated automatically
- User can review changes before committing

**Cons:**
- Parameter file query might drift from graph if user doesn't commit
- But this is OK! Param file just becomes "slightly stale" until next "Get from Source"

---

### Option B: Auto-Put Query Before Get (Alternative)

**Approach:** Before "Get from Source", automatically do a "Put to File" just for the query field.

**Workflow:**
```typescript
async function getFromSource(edge: GraphEdge) {
  // 1. Check if query has changed
  const paramFile = await loadParameter(edge.parameter_id);
  if (edge.query !== paramFile.query && !edge.query_overridden) {
    // 2. Auto-put query to file first
    await updateManager.handleGraphToFile(
      'UPDATE',
      'parameter', 
      {query: edge.query},  // Just the query
      edge.parameter_id
    );
    // Param file now marked dirty
  }
  
  // 3. Now proceed with normal "Get from Source"
  const connection = paramFile.connection;
  const connector = getConnector(connection.type);
  // ... rest of retrieval
}
```

**Pros:**
- Parameter file always has correct query
- Connector can read everything from param file
- More "traditional" data flow

**Cons:**
- Two operations instead of one
- User might not want query updated yet
- Still requires connection settings from param file anyway

---

### Option C: Connection Settings on Graph (Not Recommended)

**Approach:** Store connection settings on the graph edge, not just in param file.

```typescript
interface GraphEdge {
  // ... existing fields
  data_source?: {
    type: 'amplitude' | 'sheets';
    config: {
      // amplitude-specific or sheets-specific config
    };
  };
}
```

**Pros:**
- Graph is self-contained
- No param file needed for direct connections

**Cons:**
- Duplicates connection config across multiple edges
- Connection secrets in graph file (security risk!)
- Violates "param file as source of truth" principle
- **Already supported for "direct" connections** (bypass param file)

---

## Recommended Solution: Option A

### Implementation

**1. UpdateManager.handleExternalToGraph() logic:**

```typescript
async handleExternalToGraph(
  operation: 'UPDATE',
  subdest: 'parameter',
  edge: GraphEdge,
  pathway: 'via-file' | 'direct'
) {
  if (pathway === 'via-file') {
    // DEFAULT PATHWAY: DatabaseZap → Folders → TrendingUpDown
    
    // Get query from graph, connection from file
    const query = edge.query;
    const paramFile = await loadParameter(edge.parameter_id);
    const connection = paramFile.connection;
    
    if (!connection) {
      throw new Error(`No connection configured for ${edge.parameter_id}`);
    }
    
    // Execute retrieval
    const connector = await getConnector(connection.type);
    const data = await connector.retrieve({
      query,  // From graph (MSMDC-updated)
      ...connection.config
    });
    
    // Update param file (query + new value)
    paramFile.query = query;  // Sync query from graph
    paramFile.values.push({
      mean: data.mean,
      n: data.n,
      k: data.k,
      window_from: data.window_from,
      window_to: data.window_to,
      retrieved_at: new Date().toISOString(),
      data_source: {
        type: connection.type,
        retrieved_at: new Date().toISOString()
      }
    });
    
    // Mark param file + index dirty
    await fileRegistry.updateFile(`parameter-${edge.parameter_id}`, paramFile);
    
    // Update graph from file (standard file-to-graph flow)
    await this.handleFileToGraph('UPDATE', 'parameter', paramFile, edge.uuid);
    
    this.emit('updateComplete', {
      type: 'external_to_graph',
      pathway: 'via-file',
      paramFile: edge.parameter_id,
      filesMarkedDirty: [edge.parameter_id, 'parameters-index']
    });
    
  } else {
    // OVERRIDE PATHWAY: DatabaseZap → TrendingUpDown
    // (Direct, no param file)
    // ... existing direct logic
  }
}
```

**2. Connection Settings UI:**

Per user request, add to **Lightning Menu**:

```typescript
┌─────────────────────────────────────────────────────────┐
│ Get from File                                           │
│   Folders → TrendingUpDown                             │
│                                                         │
│ Get from Source                                         │
│   DatabaseZap → Folders → TrendingUpDown               │
│                                                         │
│ Get from Source (direct)                                │
│   DatabaseZap → TrendingUpDown                         │
│                                                         │
│ Put to File                                             │
│   TrendingUpDown → Folders                             │
│ ─────────────────────────────────────────────────────  │
│ Connection Settings...                                  │  // NEW
│ Sync Status...                                          │
└─────────────────────────────────────────────────────────┘
```

**"Connection Settings..." opens modal:**

```typescript
┌──────────────────────────────────────────────────┐
│ Connection Settings                              │
│ Parameter: checkout-conversion                   │
├──────────────────────────────────────────────────┤
│                                                  │
│ Source Type:                                     │
│   ● Amplitude                                    │
│   ○ Google Sheets                                │
│   ○ Custom API                                   │
│   ○ Manual only (no external source)             │
│                                                  │
│ ─────────── Amplitude Configuration ───────────  │
│                                                  │
│ Workspace: [my-workspace ▼]                      │
│                                                  │
│ API Credentials: [amplitude-prod ▼]              │
│                                                  │
│ Event Mapping: (auto-configured from query)      │
│   from(checkout)  → event: checkout_started      │
│   to(purchase)    → event: purchase_complete     │
│                                                  │
│ [ ] Advanced query options...                    │
│                                                  │
│             [Cancel]  [Save to File]             │
└──────────────────────────────────────────────────┘
```

**Behavior:**
- Reads current `connection` from parameter file (if exists)
- User can edit connection settings
- "Save to File" writes to parameter file `connection` object
- Marks param file + index dirty
- Does NOT change graph

**Why on lightning menu, not prop panel:**
- Per-parameter settings (not per-edge)
- Occasional use case (set once, rarely change)
- Keeps prop panel uncluttered

---

## Schema Validation

### Parameter File Schema (SIMPLIFIED ⚠️)

**Key Changes:**
- `connection.type` → `connection.source_type` (consistency with graph)
- `connection.config` → `connection.connection_settings` (opaque JSON blob)
- NO secrets! Credentials managed separately in `credentials.yaml`

```yaml
id: checkout-conversion
type: probability
query: "from(checkout).to(purchase)"
query_overridden: false  # If true, graph won't auto-update this

connection:  # ⚠️ SIMPLIFIED
  source_type: amplitude  # enum: amplitude | sheets | api | manual
  connection_settings: |  # JSON blob (auto-generated by connection service)
    {
      "event_from": "checkout",
      "event_to": "purchase",
      "exclude": ["mobile"],
      "credential_ref": "amplitude-prod"  # Reference to credentials.yaml
    }

values:
  - mean: 0.3
    n: 1000
    k: 300
    window_from: "2025-01-01T00:00:00Z"
    retrieved_at: "2025-01-15T12:00:00Z"
    data_source:
      type: amplitude
      retrieved_at: "2025-01-15T12:00:00Z"
```

**Credentials managed separately:**
```yaml
# credentials.yaml (in repo root, gitignored)
amplitude-prod:
  type: amplitude
  workspace: my-workspace
  api_key: <secret>

sheets-readonly:
  type: google_sheets
  service_account_json: <secret>
```

### Graph Edge Schema (SIMPLIFIED ⚠️)

**Key Insight:** Connection settings are minimal - NO secrets, NO explicit config fields!
- Secrets → `credentials.yaml` (managed separately)
- Standard connections → Managed by connection service
- Only need: `source_type` + opaque `connection_settings` JSON blob

```typescript
interface GraphEdge {
  query: string;  // ✅ Auto-generated by MSMDC
  query_overridden: boolean;  // ✅ Tracks manual edits
  
  p?: {
    parameter_id?: string;  // Link to param file
    mean: number;
    mean_overridden: boolean;
    evidence?: {...};
    
    // NEW: Minimal connection settings (per-parameter)
    data_source?: {
      source_type: 'amplitude' | 'sheets' | 'api' | 'manual';  // ✅ Simple enum
      connection_settings: string;  // ✅ JSON blob (opaque, auto-generated by connection service)
      connection_overridden: boolean;  // ✅ NEW - Prevents sync from param file
    };
  };
  
  cost_gbp?: {
    parameter_id?: string;
    mean: number;
    mean_overridden: boolean;
    
    data_source?: {  // Separate connection for cost data
      source_type: 'sheets';
      connection_settings: string;  // Different JSON for sheets
      connection_overridden: boolean;
    };
  };
}
```

**What's in `connection_settings` JSON blob?**
- **Amplitude:** `{"event_from": "checkout", "event_to": "purchase", "exclude": ["mobile"]}`
- **Sheets:** `{"sheet_id": "abc123", "range": "A1:B10"}`
- **API:** `{"endpoint": "/conversions", "params": {...}}`

**Who generates this blob?**
- **Connection Service** (not UpdateManager!)
- Connection service has method: `generateConnectionSettings(query, window, source_type)`
- UpdateManager just propagates blob between graph ↔ file

---

## Key Decisions (UPDATED)

### ✅ DECISION 1: Bidirectional Override Pattern

**Two pieces of data, opposite mastery:**

1. **Query:** Mastered on GRAPH, cached on PARAM FILE
   - Graph: `edge.query` (MSMDC auto-generated)
   - Param file: `query` + `query_overridden` flag
   - Sync: Graph → File (if `query_overridden = false`)

2. **Connection Settings:** Mastered on PARAM FILE, cached/overridden on GRAPH
   - Param file: `connection` object (canonical)
   - Graph: `edge.p.data_source` + `connection_overridden` flag
   - Sync: File → Graph (if `connection_overridden = false`)

**Why this works:**
- Graph knows structure → generates correct queries
- Param file knows credentials → provides stable connection config
- Both can be overridden for flexibility
- Auto-sync keeps them aligned (when not overridden)

---

### ✅ DECISION 2: Support Ad-Hoc Prototyping (No Param Files Required)

**Use case:**
- User drags nodes, creates edge, clicks "Get from Source"
- No param file exists yet
- Edge stores `data_source` directly (standalone)

**Implementation:**
- `edge.p.data_source` is populated on first use (prompt or defaults)
- No `parameter_id` → uses direct connection
- Data stored in `edge.p.evidence` (no file, no history)

**This enables rapid exploration without file overhead.**

---

### ✅ DECISION 3: Auto-Sync Query During Any Graph↔File Operation

**Trigger events:**
- "Get from Source (via file)" - retrieving from external source
- "Put to File" - saving graph values to param file
- "Get from File" - pulling param file values to graph

**Behavior:**
- If `paramFile.query_overridden = false`:
  - Update `paramFile.query = edge.query`
  - Mark param file dirty
- If `paramFile.query_overridden = true`:
  - Skip query update
  - Respect user's manual query

**This keeps param file query aligned with current graph structure.**

---

### ✅ DECISION 4: Auto-Sync Connection During File→Graph Operations

**Trigger events:**
- "Get from File" - pulling param file values to graph
- "Get from Source (via file)" - need connection from file

**Behavior:**
- If `edge.data_source.connection_overridden = false` (or undefined):
  - Copy `paramFile.connection` → `edge.data_source`
  - Set `edge.data_source.connection_overridden = false`
- If `edge.data_source.connection_overridden = true`:
  - Skip connection update
  - Use edge's override connection

**This allows edge-specific connection overrides (e.g., test vs prod workspace).**

---

### ✅ DECISION 5: "Shared Param File" Behavior

**Problem:** Multiple graphs might use same param file with different queries.

**Resolution:**
1. **If graphs have same structure** → Same MSMDC query → No conflict ✅
2. **If graphs have different structure** → Different queries → Conflict ⚠️
   - Last graph to sync updates param file query
   - If this is undesirable, user has 3 options:
     - a) Use different param files (recommended)
     - b) Set `paramFile.query_overridden = true` to freeze query
     - c) Accept that param file query matches last-used graph

**This is acceptable:** Param files are "reusable templates", but query is context-specific.

---

### ✅ DECISION 6: Connection Settings UI on Lightning Menu

**Why lightning menu, not prop panel:**
- Per-parameter settings (shared across edges using same param file)
- Occasional use case (set once, rarely change)
- Keeps prop panel focused on data values

**Modal shows:**
- Source type (Amplitude, Sheets, API)
- Source-specific config (workspace, credentials, etc.)
- Save target: "Save to File" OR "Save to Edge" (override)

---

### ✅ DECISION 7: No Automation in Param File Editor

**Param file editor is just YAML form** - no smart behaviors, no automation.

**To freeze query from graph updates:**
- User manually edits YAML: `query_overridden: true`
- No UI toggle, no automation
- Simple and explicit

**UpdateManager Responsibility:**
- Watches for graph changes (node add/remove/edit)
- Triggers MSMDC to regenerate affected queries
- Cascades query updates to param files (if `query_overridden = false`)
- Syncs connection settings back to graph (if `connection_overridden = false`)
- ALL automation happens via UpdateManager, NOT in param editor

---

### ✅ DECISION 8: Connection Service Generates `connection_settings` Blob

**UpdateManager does NOT generate connection settings!**

**Responsibility Split:**
- **Connection Service:**
  - Method: `generateConnectionSettings(query, window, source_type, credential_ref)`
  - Parses query DSL (`from(A).to(B).exclude(C)`)
  - Builds source-specific JSON blob
  - Example for Amplitude: `{"event_from": "A", "event_to": "B", "exclude": ["C"], "credential_ref": "amp-prod"}`
  
- **UpdateManager:**
  - Just propagates `connection_settings` blob between graph ↔ file
  - Treats blob as opaque string
  - Never parses or modifies it

**Benefits:**
- UpdateManager stays simple (data movement only)
- Connection Service owns source-specific logic
- Easy to add new source types (just extend Connection Service)

---

## Implementation Checklist

### Phase 1 (Schema & Core Logic)
- [ ] **Update graph schema** to add `connection_overridden` flag to `data_source` object
- [ ] **Update UpdateManager** to implement bidirectional sync:
  - [ ] Query sync: Graph → File (if `query_overridden = false`)
  - [ ] Connection sync: File → Graph (if `connection_overridden = false`)
- [ ] **Update `handleExternalToGraph()`** to:
  - [ ] Use graph query (always)
  - [ ] Use param file connection (unless overridden on edge)
  - [ ] Auto-update param file query during retrieval
  - [ ] Mark param file + index dirty
- [ ] **Add detection logic** for ad-hoc vs file-backed mode
- [ ] **Add tests** for bidirectional sync and override logic

### Phase 1 (UI - Lightning Menu)
- [ ] Add "Connection Settings..." to lightning menu
- [ ] Create ConnectionSettingsModal component
  - [ ] Show current connection source (file vs edge override)
  - [ ] Allow editing connection settings
  - [ ] Two save options: "Save to File" OR "Save to Edge (Override)"
  - [ ] Show "inherited from {param_id}" indicator when applicable
- [ ] Stub implementation (show "Feature coming soon" toast)

### Future Phases (External Connectors)
- [ ] Create Amplitude connector with config UI
- [ ] Create Google Sheets connector with config UI
- [ ] Create generic API connector with config UI
- [ ] Implement connection defaults/auto-generation on first use
- [ ] Add connection validation

---

## Resolved Questions

### ✅ Q1: Warn user if query has changed?
**Resolution:** Silent sync. User sees dirty file in Navigator and can review before commit.

### ✅ Q2: Respect `paramFile.query_overridden = true`?
**Resolution:** Yes. If param file has `query_overridden = true`, skip auto-update from graph. This allows user to freeze param file query across multiple graphs.

### ✅ Q3: Show "inherited from {param_id}" in UI?
**Resolution:** Yes. Connection Settings modal should clearly indicate:
- "Connection source: Inherited from parameter file '{param_id}'" (if not overridden)
- "Connection source: Overridden on this edge" (if overridden)

### ✅ Q4: Can edge override connection for file-backed params?
**Resolution:** Yes! This is "Pathway C: Hybrid Mode"
- Edge has `parameter_id` (file-backed)
- Edge also has `data_source` with `connection_overridden = true`
- Retrieval uses edge connection, but still appends to param file
- Use case: Test staging workspace but keep data in canonical param file

---


