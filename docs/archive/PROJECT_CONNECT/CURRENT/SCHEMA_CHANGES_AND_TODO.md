# Schema Changes Required & TODO List

**Date:** 2025-11-05  
**Status:** Pre-Phase 1 Completion Check

---

## 1. Schema Changes Required

### 1.1 Graph Schema (`conversion-graph-1.0.0.json`)

**Already Complete ‚úÖ:**
- `uuid` / `id` renaming
- `edge.p.mean` with `mean_overridden`
- `edge.p.evidence` object
- `edge.query` and `query_overridden`
- `node.event_id`

**Still Needed ‚ö†Ô∏è:**

#### A. Edge Connection Settings
```json
"p": {
  "type": "object",
  "properties": {
    "parameter_id": {"type": "string"},
    "mean": {"type": "number"},
    "mean_overridden": {"type": "boolean"},
    
    // NEW:
    "data_source": {
      "type": "object",
      "properties": {
        "source_type": {
          "type": "string",
          "enum": ["amplitude", "sheets", "api", "manual"]
        },
        "connection_settings": {
          "type": "string",
          "description": "JSON blob auto-generated by connection service"
        },
        "connection_overridden": {
          "type": "boolean",
          "description": "If true, don't sync from param file"
        }
      }
    }
  }
}
```

**Apply to:** `p`, `cost_gbp`, `cost_time` (each can have its own connection)

---

### 1.2 Parameter Schema (`parameter-schema.yaml`)

**Already Complete ‚úÖ:**
- `query` field
- `values[]` array with `n`, `k`, `window_from`, `window_to`

**Still Needed ‚ö†Ô∏è:**

#### A. Query Override Flag
```yaml
query: "from(checkout).to(purchase)"
query_overridden: false  # NEW - If true, graph won't auto-update this
```

#### B. Simplified Connection Settings
```yaml
connection:  # NEW - simplified from old design
  source_type: amplitude  # enum: amplitude | sheets | api | manual
  connection_settings: |  # JSON blob (opaque, auto-generated)
    {
      "event_from": "checkout",
      "event_to": "purchase",
      "exclude": ["mobile"],
      "credential_ref": "amplitude-prod"
    }
```

**Remove:** Old `connection.type` and `connection.config` structure (if present)

---

### 1.3 Case Schema (`case-schema.yaml`)

**Check if needed ‚ö†Ô∏è:**
- Does case schema need similar connection settings for Statsig/Optimizely?
- If yes, add same pattern:
  ```yaml
  connection:
    source_type: statsig
    connection_settings: |
      {"experiment_id": "checkout-redesign", "credential_ref": "statsig-prod"}
  ```

---

### 1.4 Sample Files to Update

**After schema changes, update:**
- `/param-registry/test/parameters/*.yaml` - Add `query_overridden`, update `connection`
- `/param-registry/test/cases/*.yaml` - Add connection if needed
- `/param-registry/test/WA-case-conversion.json` - Update edge structure with `data_source`

---

## 2. Open Questions

### ‚úÖ ALL RESOLVED

All design questions from `CONNECTION_SETTINGS_WORKFLOW.md` have been resolved:
- Query mastery (graph) vs connection mastery (file)
- Bidirectional override pattern
- UpdateManager cascade flow
- Connection Service responsibility
- No automation in param editor
- Param usage indicators in UI

**No open questions remaining!**

---

## 3. TODO List: UI Work

### 3.1 Properties Panel (BLOCKING - Phase 1.1)

**From `PHASE_1_PROPERTIES_PANEL_SCHEMA_AUDIT.md`:**

**CRITICAL (Must fix for Phase 1):**
1. ‚ùå Add `edge.label` and `edge.label_overridden` field + indicator
2. ‚ùå Add `edge.p.evidence` display (read-only, show n/k/window)
3. ‚ùå Add `node.event_id` selector (EnhancedSelector)
4. ‚ùå Fix `locked` ‚Üí `mean_overridden` (wrong field name)
5. ‚ùå Add override indicators (`<Zap>`/`<ZapOff>`) throughout
   - `edge.label`, `edge.p.mean`, `edge.p.stdev`, `edge.p.distribution`
   - `edge.cost_gbp.mean`, `edge.cost_time.mean`
   - `edge.description`, `edge.query`
   - `node.label`, `node.description`

**MEDIUM (Phase 2):**
6. ‚ö†Ô∏è Clarify `cost_gbp`/`cost_time` structure (object vs primitive)
7. ‚ö†Ô∏è Add `query_overridden` support
8. ‚ö†Ô∏è Add `description_overridden` support
9. ‚ö†Ô∏è Clarify `case.parameter_id` (is this in schema?)

**LOW (Phase 3):**
10. üìù Remove stale "slug" comments

**Estimated effort:** 2-3 days for CRITICAL items

---

### 3.2 Connect/Selector Enhancements (Phase 1.2)

**From `PHASE_1_UI_INTEGRATION_MAP.md`:**

1. ‚úÖ Add "Connection Settings..." to lightning menu (stub)
2. ‚úÖ Add parameter usage indicator `[N graphs] üìä`
   - Count graphs using each param
   - Click badge ‚Üí Modal with graph list
3. ‚úÖ Lightning menu actions (Get from File, Put to File, etc.)
4. ‚úÖ Auto "Get from File" on first connect
5. ‚úÖ "+ Create File" behavior

**Estimated effort:** 2-3 days

---

### 3.3 Context Menus (Phase 1.3)

**From `PHASE_1_UI_INTEGRATION_MAP.md`:**

1. ‚úÖ Node context menu: "Get from File", "Get from Source", "Put to File"
2. ‚úÖ Case node context menu: Same as node
3. ‚úÖ Edge context menu: Per-parameter actions (p, cost_gbp, cost_time)

**Estimated effort:** 1 day

---

### 3.4 Data Menu (Phase 1.4)

**From `PHASE_1_UI_INTEGRATION_MAP.md`:**

1. ‚úÖ Top menu: "Get All from Files...", "Put All to Files...", "Sync Status..."
2. ‚úÖ Batch operation modal (selection tree)
3. ‚úÖ Stub "Get from Source" operations (toast: "Feature coming soon")

**Estimated effort:** 1-2 days

---

### 3.5 Events UI (Phase 1.5)

**From `PHASE_1_EVENTS_IMPLEMENTATION.md`:**

1. ‚úÖ Add Events section to Navigator (yellow theme)
2. ‚úÖ Events registry service integration
3. ‚úÖ EnhancedSelector for events
4. ‚úÖ Event file editor (form + YAML tabs)
5. ‚úÖ Event connect/selector in node properties

**Estimated effort:** 2 days

---

## 4. Blocking Analysis

### What's Blocking Immediate Next Phase?

**Phase 1.1 (Properties Panel) is BLOCKING because:**
- Properties Panel is the **primary UI** for data editing
- Users will interact with override flags here
- Lightning menu requires Properties Panel changes to work
- Without override indicators, users can't tell what's synced vs manual

**Everything else can proceed in parallel:**
- Schema updates (non-blocking, just YAML edits)
- Connect/Selector enhancements (independent of Props Panel)
- Context menus (independent)
- Data menu (independent)
- Events UI (independent)

**Recommendation:**
1. **Do schema updates NOW** (30 min - 1 hour)
2. **Start Properties Panel work** (2-3 days, CRITICAL path)
3. **Parallelize other UI work** (can be done by different dev or after Props Panel)

---

## 5. Documentation Required

### User-Facing Docs (graph-editor/src/public/docs/)

**Per user request:** "all of this overridden / propagation logic, and the detailed operations of the update service, is subtle and fiddly and will need to be documented properly"

**New docs needed:**

#### 5.1 `/docs/data-connections/override-pattern.md`
**Content:**
- What are `_overridden` flags?
- How to manually override a field
- How to clear an override (allow auto-sync)
- Icon meanings (`<Zap>` filled/stroke, `<ZapOff>`)
- Examples: Overriding probability, connection settings, query

#### 5.2 `/docs/data-connections/query-sync.md`
**Content:**
- How MSMDC auto-generates queries
- How graph queries sync to param files
- When to set `query_overridden = true`
- Shared param file behavior (multi-graph scenarios)

#### 5.3 `/docs/data-connections/connection-settings.md`
**Content:**
- Connection settings mastery (file vs graph)
- Ad-hoc mode (graph-only, no param files)
- Canonical mode (file-backed, reusable)
- Hybrid mode (file-backed with edge override)
- Credentials management (`credentials.yaml`)

#### 5.4 `/docs/data-connections/update-manager-flow.md`
**Content:**
- UpdateManager cascade flow diagram
- Trigger events (graph change, MSMDC regenerate, user action)
- Bidirectional sync rules
- File dirty state and commit workflow
- Troubleshooting: "Why isn't my data syncing?"

#### 5.5 `/docs/data-connections/parameter-files.md`
**Content:**
- Parameter file structure
- `query_overridden` flag usage
- `connection` settings
- Multi-graph usage patterns
- When to create new param vs reuse existing

**Estimated effort:** 1 day for all docs (after implementation)

---

## 6. Summary

### Schema Changes: ‚úÖ Resolved, ready to implement
- Add `connection_overridden` to graph edge parameters
- Add `query_overridden` to param files
- Simplify connection settings (remove old structure)

### Open Questions: ‚úÖ ALL RESOLVED
- No design questions remaining

### Blocking Work: ‚ö†Ô∏è Properties Panel (Phase 1.1)
- **MUST** fix 5 critical issues before UI work is usable
- **2-3 days effort**
- All other UI work can proceed in parallel

### Documentation: üìù Required
- 5 new user docs for `/public/docs/data-connections/`
- Write **after** implementation (when behavior is finalized)

### Next Steps:
1. Update schemas (30-60 min)
2. Update sample YAML files (30 min)
3. Begin Properties Panel work (CRITICAL path)
4. Parallelize other UI work
5. Write user docs when stable

---

